function drawOrbit(a){colors=d3.scale.category20b(),orbitScale=d3.scale.linear().domain([1,3]).range([3.8,1.5]).clamp(!0),radiusScale=d3.scale.linear().domain([0,1,2,3]).range([20,10,3,1]).clamp(!0),orbit.orbitSize(function(a){return orbitScale(a.depth)}).speed(5),d3.select("svg").selectAll("g.node").data(orbit.nodes()).enter().append("g").attr("class","node").attr("transform",function(a){return"translate("+a.x+","+a.y+")"}),d3.selectAll("g.node").append("circle").attr("r",function(a){return radiusScale(a.depth)}).style("fill",function(a){return colors(a.depth)})}function startSearch(){var a=$("input[name=category]").val();return a.length>0&&(toggleSearch(),hydra.init(a)),!1}function toggleSearch(){$("#search-container").toggle("slow",function(){toggleGUI()})}function toggleGUI(){$("#gui").toggleClass("hidden")}function togglePanel(a){$("#panel-"+a).toggleClass("hidden")}function hidePanel(a){$("#panel-"+a).hasClass("hidden")||$("#panel-"+a).addClass("hidden")}function showAbstract(a,b){$("#panel-right").hasClass("hidden")&&togglePanel("right"),$("#panel-right-title").html(a),$("#panel-right-content").html(b)}Array.prototype.diff=function(a){return this.filter(function(b){return a.indexOf(b)<0})};var hydra={rootCategory:"",language:"en",setLanguage:function(a){this.language=a},width:$("body").innerWidth(),height:$("body").innerHeight(),restart:function(){var a=this;this.width,this.height,this.nodes,this.links;this.path=this.path.data(this.links),this.path.enter().append("svg:path").attr("class","link").attr("stroke-dasharray","5,5").attr("stroke-width",function(a){return this.getChildren(a.target).length+4}.bind(this)),this.path.exit().remove(),this.circle=this.circle.data(this.nodes,function(a){return a.id}),this.circle.selectAll("circle").attr("r",function(a){return a.path?12:8}).attr("class",function(a){return"node"});var b=this.circle.enter().append("svg:g").attr("class","entity").on("mousedown",function(a){this.mousedown_node=a}.bind(this));b.append("svg:circle").attr("class","transparent").attr("r",20),b.append("svg:circle").attr("class","node").attr("r",function(a){return a.path?12:8}).on("mouseover",function(b){b.clicked||(d3.select(this).attr("transform",function(a){}),a.mouseover_node=b,b.hovered=!0)}).on("mouseout",function(b){b.hovered&&(d3.select(this).attr("transform",""),a.mouseover_node=null,b.hovered=!1)}).on("mouseup",function(a){a.clicked=!1,this.mousedown_node=null}.bind(this)),b.append("svg:text").attr("x",12).attr("y",22).attr("class","shadow").text(function(a){return a.title}),b.append("svg:text").attr("x",10).attr("y",20).attr("class","title").text(function(a){return a.title}),this.circle.exit().remove(),this.force.start()},getData:function(a,b){var c=$.ajax({url:"json/getSubCategories.php?category="+a+"&lang="+this.language,type:"GET",dataType:"jsonp",async:!1});if("OK"!=c.statusText)return!1;var d=JSON.parse(c.responseText),e=[];return $.each(d,function(){this.parent=b,e.push(this)}),e},getAbstract:function(a){console.log("getData("+a+")");var b=$.ajax({url:"json/getAbstract.php?page="+a+"&lang="+this.language,type:"GET",dataType:"jsonp",async:!1});if("OK"!=b.statusText)return!1;var c=JSON.parse(b.responseText)["abstract"];return console.log("return"),console.log(c),c},getStartingNodes:function(){var a=[{title:this.rootCategory,id:0}];return $.each(this.getData(this.rootCategory,0),function(){a.push(this)}),a},findNode:function(a){for(var b=0;b<this.nodes.length;b++)if(this.nodes[b].id==a)return this.nodes[b]},findNodesbyParentId:function(a){console.log("findNodesbyParentId("+a+")");var b=[],c=this.nodes;console.log("this.nodes = "),console.log(this.nodes);for(var d=0;d<c.length;d++)c[d].parent>-1&&c[d].parent==a&&b.push(c[d]);return console.log("return"),console.log(b),b},findPathTo:function(a,b){if(!b)var b=[a];for(var c=0;c<b.length;c++)for(var d=0;d<this.nodes.length;d++)this.nodes[d].id==this.findNode(b[c]).parent&&b.push(this.nodes[d].id);return b},findPathNodesTo:function(a){console.log("findPathNodesTo()");for(var b=[a],c=0;c<b.length;c++)for(var d=0;d<this.nodes.length;d++)this.nodes[d].id==this.findNode(b[c].id).parent?(this.nodes[d].path=!0,b.push(this.nodes[d])):this.nodes[d].path=!1;return b},getChildren:function(a){var b=[];return $.each(this.nodes,function(){this.parent==a.id&&b.push(this)}),b},generateLinks:function(a){if(a.length){for(var b=[],c=0;c<a.length;c++)a[c].parent>-1&&b.push({source:this.findNode(a[c].parent),target:this.findNode(a[c].id)});return b}},getActiveNodes:function(a){this.rootNode||(this.rootNode=a[0].id);for(var b=[],c=0;c<a.length;c++)(a[c].parent==this.rootNode||a[c].id==this.rootNode)&&b.push(a[c]);return b},removeNode:function(a){for(var b=0,c=this.findNode(a);b<this.links.length;)this.links[b].source.id==a||this.links[b].target.id==a?this.links.splice(b,1):b++;var d=c.index;void 0!==d&&this.nodes.splice(d,1),this.restart()},resetMouseVars:function(){null!==this.mousedown_node&&(this.findNode(this.mousedown_node.id).clicked=!1),this.mousedown_node=null,this.mouseup_node=null,this.mousedown_link=null},mousedown:function(){if(console.log("mousedown()"),console.log(this.mousedown_node),hidePanel("right"),this.mousedown_node){if("page"==this.mousedown_node.type){var a=this.mousedown_node.title,b=this.getAbstract(a);return void showAbstract(a,b)}for(var c=this.findPathNodesTo(this.mousedown_node),d=this.getData(this.mousedown_node.title,this.mousedown_node.id),e={x:this.mousedown_node.x,y:this.mousedown_node.y},f=0;f<c.length;f++)this.mousedown_node.id!=c[f].id&&(c[f].path=!0),d.push(c[f]);var g=this.nodes.diff(d),h=d.diff(c).diff(this.nodes);console.log("Removing nodes:"),console.log(this.findNodesbyParentId(this.mousedown_node.id).length);for(var f=0;f<g.length;f++)this.removeNode(g[f].id),this.restart();$(h).each($).wait(100,function(a){h[a].x=e.x,h[a].y=e.y,this.nodes.push(h[a]),this.links.push({source:this.findNode(h[a].parent),target:h[a]}),console.log("Adding node: "+h[a].id),this.restart()}.bind(this));var i=[];c.each(function(){i.push(this.title)}),alert(i.join(" > "))}},mousemove:function(){},mouseup:function(){this.resetMouseVars()},tick:function(){var a=(this.width,this.height,this.nodes,this.links,this.circle),b=this.path;b.attr("d",function(a){var b=a.target.x-a.source.x,c=a.target.y-a.source.y,d=Math.sqrt(b*b+c*c),e=b/d,f=c/d,g=a.left?17:12,h=a.right?17:12,i=a.source.x+g*e,j=a.source.y+g*f,k=a.target.x-h*e,l=a.target.y-h*f;return"M"+i+","+j+"L"+k+","+l}).attr("class",function(a){return a.source.path?"path":"link"}),a.attr("transform",function(a){return"translate("+a.x+","+a.y+")"}).attr("class",function(a){var b=[];return b.push("entity"),b.push(a.path===!0?"trail":""),b.push(a.type),b.join(" ")})},keydown:function(){},keyup:function(){},init:function(a){this.rootCategory=a,this.svg=d3.select("#d3").append("svg").attr("width",this.width).attr("height",this.height),this.nodes=this.getStartingNodes(),this.links=this.generateLinks(this.nodes),this.labelAnchors=[],this.labelAnchorLinks=[],this.path=this.svg.append("svg:g").selectAll("path"),this.circle=this.svg.append("svg:g").selectAll("g"),this.selected_node=this.rootNode,this.selected_link=null,this.mousedown_link=null,this.mousedown_node=null,this.mouseover_node=null,this.mouseup_node=null,this.rootNode=null;this.width,this.height,this.nodes,this.links;this.force=d3.layout.force().nodes(this.nodes).links(this.links).size([this.width,this.height]).linkDistance(function(a){return a.source.path?120:80}).charge(-1600).friction(.9).linkStrength(.6).on("tick",this.tick.bind(this)),this.svg.on("mousedown",this.mousedown.bind(this)).on("mousemove",this.mousemove).on("mouseup",this.mouseup),d3.select(window).on("keydown",this.keydown).on("keyup",this.keyup),this.restart()}};$("select#language").on("change",function(){hydra.setLanguage($(this).val())}),function(a,b){function c(b,c){c=a(c),c.prevObject=b;var d=b.length;if(d!==c.length)return c;for(;d--;)if(b[d]!==c[d])return c;return b}function d(a){for(var b=[],c=a.length;c--;)b[c]=a[c].g;return b}function e(b,e,g,h){function i(a,b){function d(){a.k=c(a.f,a.k),a.e=!0,j()}return a.e=!1,"function"==typeof b.promise?b.promise().then(d):b.then(d,!0)}function j(b){for(;!p;)try{if(p=!p,"function"==typeof h&&h(a.makeArray(o.k||o.f)),0==o.e)break;if(!o.i.j){if(!m||g.length&&!g[0].b||(o.f&&"function"==typeof o.f.promise?o.f.promise().then(m.resolve):m.resolveWith(o.f),m=null),!g.length)return o.f;if(l=g[0].l&&g[0].l(j,o,g),!l)break;o=l;continue}if(k=o.f&&o.f[o.i.j]||n[o.i.j],!k)throw'no such method "'+o.i.j+'" on object ('+o.f+")";if(k.timing&&!o.e)o.e=!1,o=k.timing(j,o,g,h)||o;else{if(!k.timing&&!o.e&&(o.k=o.f[o.i.j].apply(o.f,o.i.c),g.length&&o.k&&o.k instanceof f)){i(o,o.k);continue}l={f:o.k,i:o.i.k},o.e=!1,"function"==typeof o.d&&o.d.apply(o.f,d(g)),o=l}}catch(c){throw p=!p,c}finally{p=!p}return b}g=g||[];var k,l,m,o={f:b,i:e},p=!1;return a.Deferred&&(j.promise=function(b,c){var d=(m=m||a.Deferred()).promise(c);return j(),d}),j}function f(b,c,d){this[".methods"]=c,this[".callback"]=d,this.length=0,Array.prototype.push.apply(this,a.makeArray(this._=b._=b));for(var e in b)e in f.prototype||"function"!=typeof b[e]||(this[e]=g(e))}function g(a){return f.prototype[a]=function(){return this[".methods"].j=a,this[".methods"].c=arguments,this[".methods"]=this[".methods"].k={},this[".callback"]?this[".callback"](this,a,arguments):this}}function h(b,c,d){function e(a){return a=f?c():i.x,g?b(a):a}"string"==typeof b&&(d=new Function("x","return ["+b+"\n,x]"),b=function(a,b){return b=d(a),i.x=b[1],b[0]});var f="function"==typeof c,g="function"==typeof b,i=function(a){return 1!=arguments.length?e():(i.x=a,void(f&&c(a)))};return i.x=0,i._={toString:i.$=i.toString=e.toString=e},i.mod=function(a){return h(function(b){return b%a},i)},i.add=function(a){return h(function(b){return b+a},i)},i.neg=function(){return h("-x",i)},i.$$=i.X=function(a){return h(a,i)},a.each(["a","b","c","d","e","f","g","h","i","j"],function(a,b){i[a]=i[b]=function(){i(arguments[a])}}),i}var i={},j=1,k=a.fn.each,l=a.fn.on||a.fn.bind,m=a.fn.off||a.fn.unbind,n={};a.Deferred&&(f.prototype.promise=function(b,c){return"object"==typeof b&&(c=b,b=null),this[".callback"]&&"function"==typeof this[".callback"].promise?this[".callback"].promise(b,c):a.Deferred().resolveWith(this).promise(c)}),a.each(["bind","on","one","live","delegate"],function(b,c){if(a.fn[c]){var d=a.fn[c];a.fn[c]=function(){function b(){return i?i(h):h}var c,g,h,i,j,k=this;for(c=0;c<arguments.length;c++)if("function"==typeof arguments[c]||arguments[c]&&"object"==typeof arguments[c]||arguments[c]===!1){if(arguments[c]!==a)return"function"==typeof arguments[c]&&a.guid&&(arguments[c].guid=arguments[c].guid||a.guid++),d.apply(k,arguments);break}return Array.prototype.splice.call(arguments,c,1,function(){return i=e(k.$(this),g,[{g:a.extend(Array.prototype.shift.apply(arguments),arguments),b:!0}],function(a){h.length=0,Array.prototype.push.apply(h,a)}),j&&(i.promise().then(j.resolve),j=null),i()}),a.Deferred&&(b.promise=function(b,c){return"object"==typeof b&&(c=b,b=null),i&&!b?i.promise(b,c):(j=j||a.Deferred()).promise(c)}),h=new f(d.apply(k,arguments),g={},b)}}}),a.each(["animate","load"],function(b,c){if(a.fn[c]){var d=a.fn[c];a.fn[c]=function(){for(;arguments.length&&null==arguments[arguments.length-1];)Array.prototype.pop.apply(arguments);if(this.length&&arguments.length>1&&arguments[arguments.length-1]===a){var b="_timing"+j++;return arguments[arguments.length-1]=function(){a(this).trigger(b)},this.each().one(b).all(d.apply(this,arguments))}return d.apply(this,arguments)}}}),a.each(["wait","repeat","join","then"],function(b,c){a.fn[c]=function(){var a={},b=new f(this,a,e(this,a,[],function(a){b.length=0,Array.prototype.push.apply(b,a)}));return b[c].apply(b,arguments)}}),a.fn.join.timing=function(a,b){var c,d,e=b.f.length;"string"==typeof b.i.c[0]?(c=b.i.c[0],"function"==typeof b.i.c[1]?b.d=b.i.c[1]:(d=b.i.c[1],b.d=b.i.c[2])):"function"==typeof b.i.c[0]?b.d=b.i.c[0]:(d=b.i.c[0],b.d=b.i.c[1]),b.k=b.f,b.e=!e,d?b.f.promise(null==c?"fx":c).then(function(){b.e=!0,a()}):b.f.queue(null==c?"fx":c,function(c){b.e=!--e,a(),c()})},a.fn.then.timing=function(a,b){b.d=b.i.c[0],b.k=b.f,b.e=!0,b.i.c[1]&&Array.prototype.shift.apply(b.i.c)},a.fn.wait.timing=function(e,f,g){function h(){m.call(k?m.call(o,k,h):o,"unwait",i),f.e=!0,f.k=c(f.f,f.k),e()}function i(d,g){m.call(k?m.call(a(this),k,h):a(this),"unwait",i),o=o.not(this),g||(f.k=f.k.not(this)),o.length||(f.e=f.k.length,f.k=c(f.f,f.k),b.clearTimeout(n),f={f:o}),e()}var j,k,n,o=f.f;j=f.i.c[0],f.d=f.i.c[1],l.call(o,"unwait",i),f.k=o,(null==j||j==a)&&(j=o),"function"==typeof j&&(j=j.apply(o,d(g))),"string"==typeof j?l.call(o,k=j,h):j&&"function"==typeof j.promise?j.promise().then(h):j&&"function"==typeof j.then?j.then(h,!0):n=b.setTimeout(h,Math.max(0,j))},a.fn.each=function(b){if(!b||b===a){var c={},d=new f(this,c,e(this,c,[],function(a){d.length=0,Array.prototype.push.apply(d,a)}));return d.each(b)}return k.apply(this,arguments)},a.fn.each.timing=function(d,g,h,i){function j(){if(u)p>q&&r[q]();else for(var a=0;p>a;a++)r[a]();return t}if(g.i.c[0]&&g.i.c[0]!==a)return g.e=!0,void(g.k=k.apply(g.f,g.i.c));var l,m,o,p=Math.max(g.f.length,1),q=0,r=[],s=[],t=a.extend({},g.f),u=g.i.c[0]===a;u&&b.setTimeout(function(){o=!0,d()},0);for(l in f.prototype)t[l]=j;for(t.length=p,l=0;p>l;l++)!function(b){var c=h.slice(),f=g.f.eq(b);s[b]=f.get(),c.unshift({g:b,a:function(a){q++,q==p&&(m=a.i.k),d()},h:n.all,l:function(a,b){o&&(q++,q==p&&(m=b.i),d())}}),r[b]=e(f,g.i.k,c,function(c){s[b]=c,t.length=0;for(var d=0;p>d;d++)Array.prototype.push.apply(t,s[d]);i&&i(a.makeArray(t))})}(l);g.k=t,g.e=!0,g.l=function(a,b){if(q==p)return h.shift(),{f:c(g.f,t),i:m};var d=q;return j(),q!=d?b:void 0},g.g=p,h.unshift(g)},n.all=function(b){a.extend(b.i,{k:a.extend({},b.i),j:"all",c:[]}),b.e=null},n.all.timing=function(a,b,c){if(!c.length||!c[0].h)throw".all() method must be used after .each() only";return c[0].a?void c[0].a(b):void c[0].h(b)},a.fn.repeat.timing=function(c,d,e){function f(){d.k=d.k||d.f,d.e=!0,c()}function g(){m.call(k?m.call(a(this),k,f):a(this),"unrepeat",g);var e=d.f.not(this);d.k=d.k==d.f?e:d.k,d.f=e,d.e=d.f.length&&d.e,h=d.f.length&&h,b.clearInterval(!d.f.length&&o),c()}var h,i,j,k,o;"function"==typeof d.i.c[0]?d.d=d.i.c[0]:"function"==typeof d.i.c[1]?(h=d.i.c[0],d.d=d.i.c[1]):(h=d.i.c[0],i=d.i.c[1],d.d=d.i.c[2]),d.l=function(a,b){return d.e||j?(d.g++,d.k=d.k||d.f,d.e=d.e||h&&b.f&&b.f.length,d):void 0},null==h?(i=h=!0,b.setTimeout(function(){j=!0,c()},0)):("string"==typeof h?l.call(d.f,k=h,f):o=b.setInterval(f,Math.max(0,h)),h=!1),l.call(d.f,"unrepeat",g),d.k=d.f,d.g=0,d.n=function(a){a&&g.apply(d.f),h&&f()},d.h=n.until,i&&f(),e.unshift(d)},n.until=function(b){a.extend(b.i,{k:a.extend({},b.i),j:"until",c:[]}),b.e=null},n.until.timing=function(b,c,e){if(!e.length||!e[0].h)throw".until() method must be used after .repeat() only";if(!e[0].n)return void e[0].h(c);var f=c.i.c[0],g=c.i.c[1];return f===a&&(f=null,g=c.i.c.length<=1||g),"function"==typeof f&&(f=f.apply(c.f,d(e))),null==f&&(f=!c.f.size()),"object"==typeof f&&(f=f.toString()),"number"==typeof f&&(f=e[0].g>=f-1),f?(c.e=!0,c.k=c.f,e.shift().n(f),void 0):(g&&(e[0].k=c.f),c=e[0],c.g++,c.n(f),c)},new f(n),a.each(["unwait","unrepeat"],function(b,c){a.fn[c]=function(){return this.trigger(c,arguments)}}),a.each(["wait","repeat","join","then","unwait","unrepeat"],function(b,c){a[c]=function(){var b="string"==typeof arguments[0]?Array.prototype.shift.apply(arguments):"";return a.fn[c].apply(i[b]=i[b]||a("<div>").text(b),arguments)}}),b.$$=a.$$=a.X=h,a.fn.$=function(){var c=a.apply(b,arguments);return c.prevObject=this,c}}(jQuery,window);